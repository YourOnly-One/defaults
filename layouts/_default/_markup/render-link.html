{{- $url := (urls.Parse .Destination) -}}
{{- $internal := site.GetPage .Destination -}}

{{- $fragment := $url.Fragment -}}
{{- with $fragment -}}{{ $fragment = printf "#%s" $fragment }}{{- end -}}
{{- $destination := printf "%s%s" (or $internal.RelPermalink .Destination) $fragment -}}

{{- $chat := or (strings.HasPrefix .Destination "irc") (strings.HasPrefix .Destination "xmpp") -}}
{{- $ftp := strings.HasPrefix .Destination "ftp" -}}
{{- $mail := strings.HasPrefix .Destination "mailto" -}}
{{- $magnet := strings.HasPrefix .Destination "magnet" -}}
{{- $remote := or (strings.HasPrefix .Destination "telnet") (strings.HasPrefix .Destination "ssh") (strings.HasPrefix .Destination "sftp") (strings.HasPrefix .Destination "git") (strings.HasPrefix .Destination "svn") -}}
{{- $tel := strings.HasPrefix .Destination "tel" -}}
{{- $books := or (strings.HasSuffix .Destination ".epub") (strings.HasSuffix .Destination ".mobi") -}}
{{- $docs := or (strings.HasSuffix .Destination ".pdf") (strings.HasSuffix .Destination ".txt") -}}
{{- $zip := or (strings.HasSuffix .Destination ".zip") (strings.HasSuffix .Destination ".7z") (strings.HasSuffix .Destination ".7zip") (strings.HasSuffix .Destination ".rar") (strings.HasSuffix .Destination ".tar") (strings.HasSuffix .Destination ".gz") (strings.HasSuffix .Destination ".gzip") -}}

{{- $icon := "" -}}
{{- if $chat -}}{{ $icon = "chat" }}
  {{- else if $ftp -}}{{ $icon = "ftp" }}
  {{- else if $mail -}}{{ $icon = "mail" }}
  {{- else if $magnet -}}{{ $icon = "magnet" }}
  {{- else if $remote -}}{{ $icon = "remote" }}
  {{- else if $tel -}}{{ $icon = "tel" }}
  {{- else if $books -}}{{ $icon = "books" }}
  {{- else if $docs -}}{{ $icon = "docs" }}
  {{- else if $zip -}}{{ $icon = "zip" }}
  {{- else if not $internal -}}{{ $icon = "external" }}
{{- end -}}

<a href="{{ $destination | safeURL }}"{{ with or .Title $internal.LinkTitle .Text }} title="{{ . }}"{{ end }}{{ with $icon }} class="icon_{{ . }}"{{ end }}{{ if not $internal }} rel="noopener external"{{ end }}>{{ or .Text .Title $internal.LinkTitle | safeHTML }}</a>

{{- /* TEST
  - [](filename.md)
  - [](/filename.md)
  - [](filename)
  - [](/filename)
  - [](filename.md "Title")
  - [](/filename.md "Title")
  - [](filename "Title")
  - [](/filename "Title")
  - [Text](filename.md)
  - [Text](/filename.md)
  - [Text](filename)
  - [Text](/filename)
  - [Text](filename.md "Title")
  - [Text](/filename.md "Title")
  - [Text](filename "Title")
  - [Text](/filename "Title")
  - [external](https://example.com)
  - [irc](irc://example.com)
  - [xmpp](xmpp://example.com)
  - [ftp](ftp://example.com)
  - [mail](mailto://example.com)
  - [magnet](magnet://example.com)
  - [telnet](telnet://example.com)
  - [ssh](ssh://example.com)
  - [sftp](sftp://example.com)
  - [git](git://example.com)
  - [svn](svn://example.com)
  - [tel](tel://example.com)
  - [pdf](https://example.com/file.pdf)
  - [txt](https://example.com/file.txt)
  - [epub](https://example.com/file.epub)
  - [mobi](https://example.com/file.mobi)
  - [zip](https://example.com/file.zip)
  - [7z](https://example.com/file.7z)
  - [7zip](https://example.com/file.7zip)
  - [rar](https://example.com/file.rar)
  - [tar](https://example.com/file.tar)
  - [gz](https://example.com/file.gz)
  - [tar.gz](https://example.com/file.tar.gz)
  - [gzip](https://example.com/file.gzip)
  - [tar.gzip](https://example.com/file.tar.gzip)
  */ -}}
