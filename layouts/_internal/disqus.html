{{- $pc := .Site.Config.Privacy.Disqus }}
{{- if not $pc.Disable }}
  {{- if .Site.Config.Services.Disqus.Shortname }}

    {{- $relcanonical := .Params.relcanonical }}
    {{- $relcanonical_parsed := urls.Parse $relcanonical }}
    {{- $permalink := urls.Parse .Permalink }}

    {{- $disqus_identifier_manual := .Params.disqus_identifier }}
    {{- $disqus_url_manual := .Params.disqus_url }}
    {{- $disqus_title_manual := .Params.disqus_title }}

    {{- $disqus_identifier_auto := path.Base $relcanonical_parsed.Path }}
    {{- $disqus_url_auto := $relcanonical }}
    {{- $disqus_title_auto := .Title | htmlUnescape }}

    {{- $disqusjsvars := dict
      "DisqusShortName" .Site.Config.Services.Disqus.Shortname
      "disqus_identifier_manual" $disqus_identifier_manual
      "disqus_title_manual" $disqus_title_manual
      "disqus_url_manual" $disqus_url_manual
      "disqus_identifier_auto" $disqus_identifier_auto
      "disqus_title_auto" $disqus_title_auto
      "disqus_url_auto" $disqus_url_auto
    }}
    {{- $disqusjspath := split ( path.Dir $permalink.Path ) "/" }}
    {{- $disqusjspath = index ( after 2 $disqusjspath ) }}
    {{- $disqusjspath = printf "%s/disqus.js" ( path.Join $disqusjspath ) }}
    {{- $disqusjs := resources.Get "js/disqus.js" }}
    {{- $disqusjs = $disqusjs | js.Build ( dict
      "targetPath" $disqusjspath
      "params" $disqusjsvars
    ) | minify | fingerprint "sha512" }}

    <ul>
      <li>$relcanonical = {{ $relcanonical }}</li>
      <li>$disqus_identifier_manual = {{ $disqus_identifier_manual }}</li>
      <li>$disqus_identifier_auto = {{ $disqus_identifier_auto }}</li>
      <li>$disqus_url_manual = {{ $disqus_url_manual }}</li>
      <li>$disqus_url_auto = {{ $disqus_url_auto }}</li>
      <li>$disqus_title_manual = {{ $disqus_title_manual }}</li>
      <li>$disqus_title_auto = {{ $disqus_title_auto }}</li>
      <li>$disqusjsvars = {{ $disqusjsvars }}</li>
      <li>$disqusjs = {{ $disqusjs }}</li>
    </ul>

    <div id="disqus_thread"></div>

    <script type="{{ $disqusjs.MediaType }}" id="" async fetchpriority="auto" crossorigin src="{{ $disqusjs.RelPermalink }}" integrity="{{ $disqusjs.Data.Integrity }}"></script>

    <noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
  {{ else }}
    <p id="hugoserver_disqus">Disqus is not available when using hugo server.</p>
  {{ end }}
{{- end -}}
